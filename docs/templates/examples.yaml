tealbase-init:
  - id: basic-usage
    name: Basic usage
    code: tealbase init
    response: Finished tealbase init.
  - id: from-workdir
    name: Initialize from an existing directory
    code: tealbase init --workdir .
    response: Finished tealbase init.
tealbase-login:
  - id: basic-usage
    name: Basic usage
    code: tealbase login
    response: |
      You can generate an access token from https://tealbase.com/dashboard/account/tokens
      Enter your access token: sbp_****************************************
      Finished tealbase login.
tealbase-link:
  - id: basic-usage
    name: Basic usage
    code: tealbase link --project-ref ********************
    response: |
      Enter your database password (or leave blank to skip): ********
      Finished tealbase link.
  - id: without-password
    name: Link without database password
    code: tealbase link --project-ref ******************** <<< ""
    response: |
      Enter your database password (or leave blank to skip):
      Finished tealbase link.
  - id: using-alternate-dns
    name: Link using DNS-over-HTTPS resolver
    code: tealbase link --project-ref ******************** --dns-resolver https
    response: |
      Enter your database password (or leave blank to skip):
      Finished tealbase link.
tealbase-start:
  - id: basic-usage
    name: Basic usage
    code: tealbase start
    response: |
      Creating custom roles tealbase/roles.sql...
      Applying migration 20220810154536_employee.sql...
      Seeding data tealbase/seed.sql...
      Started tealbase local development setup.
  - id: without-studio
    name: Start containers without studio and imgproxy
    code: tealbase start -x studio,imgproxy
    response: |
      Excluding container: tealbase/studio:20221214-4eecc99
      Excluding container: darthsim/imgproxy:v3.8.0
      Started tealbase local development setup.
  - id: ignore-health-check
    name: Ignore service health checks
    code: tealbase start --ignore-health-check
    response: |
      service not healthy: [tealbase_storage_cli]
      Started tealbase local development setup.
tealbase-stop:
  - id: basic-usage
    name: Basic usage
    code: tealbase stop
    response: |
      Stopped tealbase local development setup.
      Local data are backed up to docker volume.
  - id: clean-up
    name: Clean up local data after stopping
    code: tealbase stop --no-backup
    response: |
      Stopped tealbase local development setup.
tealbase-status:
  - id: basic-usage
    name: Basic usage
    code: tealbase status
    response: |2
      tealbase local development setup is running.

               API URL: http://127.0.0.1:54321
           GraphQL URL: http://127.0.0.1:54321/graphql/v1
                DB URL: postgresql://postgres:postgres@127.0.0.1:54322/postgres
            Studio URL: http://127.0.0.1:54323
          Inbucket URL: http://127.0.0.1:54324
            JWT secret: super-secret-jwt-token-with-at-least-32-characters-long
              anon key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0
      service_role key: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU
  - id: output-env
    name: Format status as environment variables
    code: tealbase status -o env
    response: |
      ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0"
      API_URL="http://127.0.0.1:54321"
      DB_URL="postgresql://postgres:postgres@127.0.0.1:54322/postgres"
      GRAPHQL_URL="http://127.0.0.1:54321/graphql/v1"
      INBUCKET_URL="http://127.0.0.1:54324"
      JWT_SECRET="super-secret-jwt-token-with-at-least-32-characters-long"
      SERVICE_ROLE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU"
      STUDIO_URL="http://127.0.0.1:54323"
  - id: output-custom-name
    name: Customize the names of exported variables
    code: tealbase status -o env --override-name auth.anon_key=TEALBASE_ANON_KEY --override-name auth.service_role_key=TEALBASE_SERVICE_KEY
    response: |
      Stopped services: [tealbase_inbucket_cli tealbase_rest_cli tealbase_studio_cli]
      TEALBASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0"
      DB_URL="postgresql://postgres:postgres@127.0.0.1:54322/postgres"
      GRAPHQL_URL="http://127.0.0.1:54321/graphql/v1"
      JWT_SECRET="super-secret-jwt-token-with-at-least-32-characters-long"
      TEALBASE_SERVICE_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImV4cCI6MTk4MzgxMjk5Nn0.EGIM96RAZx35lJzdJsyH-qQwv8Hdp7fsn3W0YpN81IU"
tealbase-migration-list:
  - id: basic-usage
    name: Basic usage
    code: tealbase migration list
    response: |2
            LOCAL      │     REMOTE     │     TIME (UTC)
      ─────────────────┼────────────────┼──────────────────────
                       │ 20230103054303 │ 2023-01-03 05:43:03
                       │ 20230103093141 │ 2023-01-03 09:31:41
        20230222032233 │                │ 2023-02-22 03:22:33
  - id: with-db-url
    name: Connect to self-hosted database
    code: tealbase migration list --db-url 'postgres://postgres[:percent_encoded_password]@127.0.0.1[:port]/postgres'
    response: |2
            LOCAL      │     REMOTE     │     TIME (UTC)
      ─────────────────┼────────────────┼──────────────────────
        20230103054303 │ 20230103054303 │ 2023-01-03 05:43:03
        20230103093141 │ 20230103093141 │ 2023-01-03 09:31:41
tealbase-migration-new:
  - id: basic-usage
    name: Basic usage
    code: tealbase migration new schema_test
    response: |
      Created new migration at tealbase/migrations/20230306095710_schema_test.sql.
  - id: pipe-stdin
    name: With statements piped from stdin
    code: echo "create schema if not exists test;" | tealbase migration new schema_test
    response: |
      Created new migration at tealbase/migrations/20230306095710_schema_test.sql.
tealbase-migration-repair:
  - id: basic-usage
    name: Mark a migration as reverted
    code: tealbase migration repair 20230103054303 --status reverted
    response: |
      Repaired migration history: 20230103054303 => reverted
  - id: mark-applied
    name: Mark a migration as applied
    code: tealbase migration repair 20230222032233 --status applied
    response: |
      Repaired migration history: 20230222032233 => applied
tealbase-db-diff:
  - id: basic-usage
    name: Basic usage
    code: tealbase db diff -f my_table
    response: |
      Connecting to local database...
      Creating shadow database...
      Applying migration 20230425064254_remote_commit.sql...
      Diffing schemas: auth,extensions,public,storage
      Finished tealbase db diff on branch main.

      No schema changes found
  - id: linked-project
    name: Against linked project
    code: tealbase db diff -f my_table --linked
    response: |
      Connecting to local database...
      Creating shadow database...
      Diffing schemas: auth,extensions,public,storage
      Finished tealbase db diff on branch main.

      WARNING: The diff tool is not foolproof, so you may need to manually rearrange and modify the generated migration.
      Run tealbase db reset to verify that the new migration does not generate errors.
  - id: specific-schema
    name: For a specific schema
    code: tealbase db diff -f my_table --schema auth
    response: |
      Connecting to local database...
      Creating shadow database...
      Diffing schemas: auth
      Finished tealbase db diff on branch main.

      No schema changes found
tealbase-db-dump:
  - id: basic-usage
    name: Basic usage
    code: tealbase db dump -f tealbase/schema.sql
    response: |
      Dumping schemas from remote database...
      Dumped schema to tealbase/schema.sql.
  - id: role-only
    name: Role only
    code: tealbase db dump -f tealbase/roles.sql --role-only
    response: |
      Dumping roles from remote database...
      Dumped schema to tealbase/roles.sql.
  - id: data-only
    name: Data only
    code: tealbase db dump -f tealbase/seed.sql --data-only
    response: |
      Dumping data from remote database...
      Dumped schema to tealbase/seed.sql.
tealbase-db-lint:
  - id: basic-usage
    name: Basic usage
    code: tealbase db lint
    response: |
      Linting schema: public

      No schema errors found
  - id: schema-warnings
    name: Warnings for a specific schema
    code: tealbase db lint --level warning --schema storage
    response: |
      Linting schema: storage
      [
        {
          "function": "storage.search",
          "issues": [
            {
              "level": "warning",
              "message": "unused variable \"_bucketid\"",
              "sqlState": "00000"
            }
          ]
        }
      ]
tealbase-db-push:
  - id: basic-usage
    name: Basic usage
    code: tealbase db push
    response: |
      Linked project is up to date.
  - id: self-hosted
    name: Self hosted
    code: tealbase db push --db-url "postgres://user:pass@127.0.0.1:5432/postgres"
    response: |
      Pushing migration 20230410135622_create_employees_table.sql...
      Finished tealbase db push.
  - id: dry-run
    name: Dry run
    code: tealbase db push --dry-run
    response: |
      DRY RUN: migrations will *not* be pushed to the database.
      Would push migration 20230410135622_create_employees_table.sql...
      Would push migration 20230425064254_my_table.sql...
      Finished tealbase db push.
tealbase-db-reset:
  - id: basic-usage
    name: Basic usage
    code: tealbase db reset
    response: |
      Resetting database...
      Initializing schema...
      Applying migration 20220810154537_create_employees_table.sql...
      Seeding data tealbase/seed.sql...
      Finished tealbase db reset on branch main.
tealbase-test-db:
  - id: basic-usage
    name: Basic usage
    code: tealbase test db
    response: |
      /tmp/tealbase/tests/nested/order_test.pg .. ok
      /tmp/tealbase/tests/pet_test.sql .......... ok
      All tests successful.
      Files=2, Tests=2,  6 wallclock secs ( 0.03 usr  0.01 sys +  0.05 cusr  0.02 csys =  0.11 CPU)
      Result: PASS
# TODO: use actual cli response for sso commands
tealbase-sso-show:
  - id: basic-usage
    name: Show information
    code: |-
      tealbase sso show 6df4d73f-bf21-405f-a084-b11adf19fea5 \
        --project-ref abcdefghijklmnopqrst
    response: |-
      Information about the identity provider in pretty output.
  - id: metadata-output
    name: Get raw SAML 2.0 Metadata XML
    code: |-
      tealbase sso show 6df4d73f-bf21-405f-a084-b11adf19fea5 \
        --project-ref abcdefghijklmnopqrst \
        --metadata
    response: |-
      Raw SAML 2.0 XML assigned to this identity provider. This is the
      version used in the authentication project, and if using a SAML 2.0
      Metadata URL it may change depending on the caching information
      contained within the metadata.
tealbase-sso-update:
  - id: basic-usage
    name: Replace domains
    code: |-
      tealbase sso update 6df4d73f-bf21-405f-a084-b11adf19fea5 \
        --project-ref abcdefghijklmnopqrst \
        --domains new-company.com,new-company.net
    response: |-
      Information about the updated provider.
  - id: add-domains
    name: Add an additional domain
    code: |-
      tealbase sso update 6df4d73f-bf21-405f-a084-b11adf19fea5 \
        --project-ref abcdefghijklmnopqrst \
        --add-domains company.net
    response: |-
      Information about the updated provider.
  - id: remove-domains
    name: Remove a domain
    code: |-
      tealbase sso update 6df4d73f-bf21-405f-a084-b11adf19fea5 \
        --project-ref abcdefghijklmnopqrst \
        --remove-domains company.org
    response: |-
      Information about the updated provider.
tealbase-sso-remove:
  - id: basic-usage
    name: Remove a provider
    code: |-
      tealbase sso remove 6df4d73f-bf21-405f-a084-b11adf19fea5 \
        --project-ref abcdefghijklmnopqrst
    response: |-
      Information about the removed identity provider. It's a good idea to
      save this in case you need it later on.
tealbase-sso-add:
  - id: basic-usage
    name: Add with Metadata URL
    code: |-
      tealbase sso add \
        --project-ref abcdefgijklmnopqrst \
        --type saml \
        --metadata-url 'https://...' \
        --domains company.com
    response: |-
      Information about the added identity provider. You can use
      company.com as the domain name on the frontend side to initiate a SSO
      request to the identity provider.
  - id: with-xml
    name: Add with Metadata File
    code: |-
      tealbase sso add \
        --project-ref abcdefgijklmnopqrst \
        --type saml \
        --metadata-file /path/to/metadata/file.xml \
        --domains company.com
    response: |-
      Information about the added identity provider. You can use
      company.com as the domain name on the frontend side to initiate a SSO
      request to the identity provider.
tealbase-sso-info:
  - id: basic-usage
    name: Show project information
    code: tealbase sso info --project-ref abcdefghijklmnopqrst
    response: Information about your project's SAML 2.0 configuration.
